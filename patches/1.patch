# HG changeset patch
# User Crypt <snandaku@cisco.com>
# Date 1340152183 25200
# Node ID 4e21996fc0f04223ef1339138b9fcf319d65f530
# Parent aff063e52fc65bf8bc5b449b4e1ceca477da74b6
 Bug 691234 Webrtc Backend With Basic Snapshot Support and Cleanup

diff --git a/content/media/Makefile.in b/content/media/Makefile.in
--- a/content/media/Makefile.in
+++ b/content/media/Makefile.in
@@ -11,18 +11,16 @@ include $(DEPTH)/config/autoconf.mk
 
 MODULE = content
 LIBRARY_NAME = gkconmedia_s
 LIBXUL_LIBRARY = 1
 
 EXPORTS = \
   AudioSegment.h \
   FileBlockCache.h \
-  MediaEngine.h \
-  MediaEngineDefault.h \
   MediaResource.h \
   MediaSegment.h \
   MediaStreamGraph.h \
   nsAudioAvailableEventManager.h \
   nsBuiltinDecoder.h \
   nsBuiltinDecoderStateMachine.h \
   nsBuiltinDecoderReader.h \
   nsDOMMediaStream.h \
@@ -34,17 +32,16 @@ EXPORTS = \
   VideoFrameContainer.h \
   VideoUtils.h \
   VideoSegment.h \
   $(NULL)
 
 CPPSRCS = \
   AudioSegment.cpp \
   FileBlockCache.cpp \
-  MediaEngineDefault.cpp \
   MediaResource.cpp \
   MediaStreamGraph.cpp \
   nsAudioAvailableEventManager.cpp \
   nsBuiltinDecoder.cpp \
   nsBuiltinDecoderStateMachine.cpp \
   nsBuiltinDecoderReader.cpp \
   nsDOMMediaStream.cpp \
   nsMediaCache.cpp \
@@ -82,16 +79,17 @@ endif
 ifdef MOZ_GSTREAMER
 PARALLEL_DIRS += gstreamer
 endif
 
 ifdef MOZ_MEDIA_PLUGINS
 PARALLEL_DIRS += plugins
 endif
 
+PARALLEL_DIRS += webrtc
 TEST_DIRS += test
 
 FORCE_STATIC_LIB = 1
 
 include $(topsrcdir)/config/config.mk
 include $(topsrcdir)/ipc/chromium/chromium-config.mk
 include $(topsrcdir)/config/rules.mk
 
diff --git a/content/media/webrtc/Makefile.in b/content/media/webrtc/Makefile.in
new file mode 100644
--- /dev/null
+++ b/content/media/webrtc/Makefile.in
@@ -0,0 +1,31 @@
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+
+DEPTH		= ../../..
+topsrcdir	= @top_srcdir@
+srcdir		= @srcdir@
+VPATH		= @srcdir@
+
+include $(DEPTH)/config/autoconf.mk
+
+MODULE = content
+LIBRARY_NAME = gkconwebrtc_s
+LIBXUL_LIBRARY = 1
+
+EXPORTS	+= \
+  MediaEngine.h \
+  MediaEngineDefault.h \
+  $(NULL)
+
+CPPSRCS	= \
+  MediaEngineDefault.cpp \
+  $(NULL)
+
+FORCE_STATIC_LIB = 1
+
+include $(topsrcdir)/config/rules.mk
+
+LOCAL_INCLUDES += \
+  -I$(topsrcdir)/media/webrtc/trunk/src \
+  $(NULL)
diff --git a/content/media/MediaEngine.h b/content/media/webrtc/MediaEngine.h
rename from content/media/MediaEngine.h
rename to content/media/webrtc/MediaEngine.h
--- a/content/media/MediaEngine.h
+++ b/content/media/webrtc/MediaEngine.h
@@ -45,17 +45,17 @@ public:
 
   /* Populate the human readable name of this device in the nsAString */
   virtual void GetName(nsAString&) = 0;
 
   /* Populate the UUID of this device in the nsAString */
   virtual void GetUUID(nsAString&) = 0;
 
   /* This call reserves but does not start the device. */
-  virtual already_AddRefed<nsDOMMediaStream> Allocate() = 0;
+  virtual nsresult Allocate() = 0;
 
   /* Release the device back to the system. */
   virtual nsresult Deallocate() = 0;
 
   /* Start the device and add the track to the provided SourceMediaStream, with
    * the provided TrackID. You may start appending data to the track
    * immediately after. */
   virtual nsresult Start(SourceMediaStream*, TrackID) = 0;
diff --git a/content/media/MediaEngineDefault.cpp b/content/media/webrtc/MediaEngineDefault.cpp
rename from content/media/MediaEngineDefault.cpp
rename to content/media/webrtc/MediaEngineDefault.cpp
--- a/content/media/MediaEngineDefault.cpp
+++ b/content/media/webrtc/MediaEngineDefault.cpp
@@ -34,25 +34,25 @@ MediaEngineDefaultVideoSource::GetName(n
 
 void
 MediaEngineDefaultVideoSource::GetUUID(nsAString& aUUID)
 {
   aUUID.Assign(NS_LITERAL_STRING("1041FCBD-3F12-4F7B-9E9B-1EC556DD5676"));
   return;
 }
 
-already_AddRefed<nsDOMMediaStream>
+nsresult
 MediaEngineDefaultVideoSource::Allocate()
 {
   if (mState != kReleased) {
-    return NULL;
+    return NS_ERROR_FAILURE;
   }
 
   mState = kAllocated;
-  return nsDOMMediaStream::CreateInputStream();
+  return NS_OK;
 }
 
 nsresult
 MediaEngineDefaultVideoSource::Deallocate()
 {
   if (mState != kStopped && mState != kAllocated) {
     return NS_ERROR_FAILURE;
   }
@@ -111,17 +111,16 @@ MediaEngineDefaultVideoSource::Start(Sou
   data.mPicY = 0;
   data.mPicSize = gfxIntSize(WIDTH, HEIGHT);
   data.mStereoMode = layers::STEREO_MODE_MONO;
 
   // SetData copies data, so we can free the frame
   mImage->SetData(data);
   PR_Free(frame);
 
-
   // AddTrack takes ownership of segment
   VideoSegment *segment = new VideoSegment();
   segment->AppendFrame(image.forget(), USECS_PER_S / FPS, gfxIntSize(WIDTH, HEIGHT));
   mSource->AddTrack(aID, RATE, 0, segment);
 
   // We aren't going to add any more tracks
   mSource->AdvanceKnownTracksTime(STREAM_TIME_MAX);
 
@@ -204,46 +203,47 @@ MediaEngineDefaultAudioSource::GetName(n
 
 void
 MediaEngineDefaultAudioSource::GetUUID(nsAString& aUUID)
 {
   aUUID.Assign(NS_LITERAL_STRING("B7CBD7C1-53EF-42F9-8353-73F61C70C092"));
   return;
 }
 
-already_AddRefed<nsDOMMediaStream>
+nsresult
 MediaEngineDefaultAudioSource::Allocate()
 {
   if (mState != kReleased) {
-    return NULL;
+    return NS_ERROR_FAILURE;
   }
+
   mState = kAllocated;
-  return nsDOMMediaStream::CreateInputStream();
+  return NS_OK;
 }
 
 nsresult
 MediaEngineDefaultAudioSource::Deallocate()
 {
   if (mState != kStopped && mState != kAllocated) {
     return NS_ERROR_FAILURE;
   }
   mState = kReleased;
   return NS_OK;
 }
 
 nsresult
 MediaEngineDefaultAudioSource::Start(SourceMediaStream* aStream, TrackID aID)
 {
   if (mState != kAllocated) {
-    return NULL;
+    return NS_ERROR_FAILURE;
   }
 
   mTimer = do_CreateInstance(NS_TIMER_CONTRACTID);
   if (!mTimer) {
-    return NULL;
+    return NS_ERROR_FAILURE;
   }
 
   mSource = aStream;
 
   // AddTrack will take ownership of segment
   AudioSegment* segment = new AudioSegment();
   segment->Init(CHANNELS);
   mSource->AddTrack(aID, RATE, 0, segment);
diff --git a/content/media/MediaEngineDefault.h b/content/media/webrtc/MediaEngineDefault.h
rename from content/media/MediaEngineDefault.h
rename to content/media/webrtc/MediaEngineDefault.h
--- a/content/media/MediaEngineDefault.h
+++ b/content/media/webrtc/MediaEngineDefault.h
@@ -40,17 +40,17 @@ class MediaEngineDefaultVideoSource : pu
 public:
   MediaEngineDefaultVideoSource() : mTimer(nsnull), mState(kReleased) {}
   ~MediaEngineDefaultVideoSource(){};
 
   virtual void GetName(nsAString&);
   virtual void GetUUID(nsAString&);
 
   virtual MediaEngineVideoOptions GetOptions();
-  virtual already_AddRefed<nsDOMMediaStream> Allocate();
+  virtual nsresult Allocate();
 
   virtual nsresult Deallocate();
   virtual nsresult Start(SourceMediaStream*, TrackID);
   virtual nsresult Stop();
   virtual nsresult Snapshot(PRUint32 aDuration, nsIDOMFile** aFile);
 
   NS_DECL_ISUPPORTS
   NS_DECL_NSITIMERCALLBACK
@@ -70,17 +70,17 @@ class MediaEngineDefaultAudioSource : pu
 {
 public:
   MediaEngineDefaultAudioSource() : mTimer(nsnull), mState(kReleased) {}
   ~MediaEngineDefaultAudioSource(){};
 
   virtual void GetName(nsAString&);
   virtual void GetUUID(nsAString&);
 
-  virtual already_AddRefed<nsDOMMediaStream> Allocate();
+  virtual nsresult Allocate();
 
   virtual nsresult Deallocate();
   virtual nsresult Start(SourceMediaStream*, TrackID);
   virtual nsresult Stop();
   virtual nsresult Snapshot(PRUint32 aDuration, nsIDOMFile** aFile);
 
   NS_DECL_ISUPPORTS
   NS_DECL_NSITIMERCALLBACK
diff --git a/layout/build/Makefile.in b/layout/build/Makefile.in
--- a/layout/build/Makefile.in
+++ b/layout/build/Makefile.in
@@ -124,16 +124,17 @@ SHARED_LIBRARY_LIBS	+= \
   $(DEPTH)/dom/system/gonk/$(LIB_PREFIX)domsystemgonk_s.$(LIB_SUFFIX) \
   $(DEPTH)/dom/telephony/$(LIB_PREFIX)domtelephony_s.$(LIB_SUFFIX) \
   $(NULL)
 endif #}
 
 ifdef MOZ_MEDIA
 SHARED_LIBRARY_LIBS 	+= \
 	$(DEPTH)/content/media/$(LIB_PREFIX)gkconmedia_s.$(LIB_SUFFIX) \
+	$(DEPTH)/content/media/webrtc/$(LIB_PREFIX)gkconwebrtc_s.$(LIB_SUFFIX) \
 	$(NULL)
 endif
 
 ifdef MOZ_OGG
 SHARED_LIBRARY_LIBS 	+= \
 	$(DEPTH)/content/media/ogg/$(LIB_PREFIX)gkconogg_s.$(LIB_SUFFIX) \
 	$(NULL)
 endif
